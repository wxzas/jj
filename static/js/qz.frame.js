"use strict";var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e)){var n=t,i=[],s=!0,t=!1,o=void 0;try{for(var a,r=e[Symbol.iterator]();!(s=(a=r.next()).done)&&(i.push(a.value),!n||i.length!==n);s=!0);}catch(e){t=!0,o=e}finally{try{!s&&r.return&&r.return()}finally{if(t)throw o}}return i}throw new TypeError("Invalid attempt to destructure non-iterable instance")};function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}var _Qz=Qz,frameService=_Qz.frameService,filterMenu=(Vue.component("nav-menu",{name:"nav-menu",template:'<div class="menu-wrapper">\n    <template v-for="(menu, index) in menuList">\n      <el-submenu v-if="menu.children.length" :index="menu.index">\n        <template slot="title">\n          <i :class="[menu.pic ? menu.pic : \'iconicon-test\', \'qz-submenu-icon\']"></i>\n          <span>{{menu.label}}</span>\n        </template>\n        <nav-menu class="nest-menu" :menu-list="menu.children" @favorite="onFavorite"></nav-menu>\n      </el-submenu>\n      <el-menu-item v-else class="qz-menu-item qz-ellipsis" \n          @mouseover.native="itemTouched($event, menu, index)"  \n          @mouseout.native="itemLeaved($event, index)" \n          :data-url="menu.index" \n          :index="menu.index"\n          style="padding-left:20px;">\n        <span slot="title" ref="spanTitle">\n          {{menu.label}}\n        </span>\n        \x3c!--<i class="icon-favorite el-icon-star-off" v-if="!menu.favorite" @click="onFavorite(menu)"></i>--\x3e\n        \x3c!--<i class="icon-favorite el-icon-star-on" v-if="menu.favorite" @click="onFavorite(menu)"></i>--\x3e\n        <el-tooltip \n        effect="dark" \n        :ref="menu.index"\n        :content="tooltipContent"\n        placement="right"\n        :manual="true"\n        :value="tooltipValue === menu.index"\n        >\n        <span style="visibility: hidden;position:absolute;right:0;top:15px;"></span>\n        </el-tooltip>\n      </el-menu-item>\n      \n    </template>\n  </div>',props:{menuList:{type:Array,required:!0}},data:function(){return{tooltipContent:"",timer:"",leaveTime:"",tooltipValue:""}},computed:{},mounted:function(){},methods:{itemTouched:function(t,n,i){var s=this;this.leaveTime&&clearTimeout(this.leaveTime),this.timer=setTimeout(function(){var e;t.ctrlKey?Qz.frameService.showLinkInfo(n.code).then(function(e){s.tooltipContent=e.pathIndexToCodeName,s.tooltipValue=n.index}):190<(e=s.$refs.spanTitle[i].getBoundingClientRect()).x+e.width&&(s.tooltipContent=n.label,s.tooltipValue=n.index)},50)},itemLeaved:function(e,t){var n=this;this.$nextTick(function(){clearTimeout(n.timer),n.leaveTime=setTimeout(function(){n.tooltipValue=""},2e3)})},onFavorite:function(e){this.$emit("favorite",e)}}}),Qz.init().then(function(e){var e=_slicedToArray(e,2),t=e[0],e=e[1],n="2"===Qz.settings.blank?{path:"/",name:"dashboard",component:Qz.component({module:"dashboard",template:"dashboard.html",scripts:["dashboard.service.js","dashboard.js"]})}:{path:"/",name:"dashboard",component:{template:"<div></div>",created:function(){http.postJSON("GRZX01_jwPublic.controller.UserIndexController.findUserDetail",{sctype:"rmdx",userType:Qz.loginUser.userType||""},{},{loading:!1})}}},i=Qz.switch.selectCourse?[{path:"/:id",name:"dashboard",component:Qz.component({module:"dashboard",template:"dashboard.html",scripts:["dashboard.service.js","dashboard.js"]})},{path:"/zygl/frame-page/",name:"frame",component:Qz.component({module:"frame-page",template:"frame.html",scripts:["frame.js"]})}]:[{path:"/:id",redirect:"/"},{path:"/",name:"dashboard",component:Qz.component({module:"dashboard",template:"dashboard.html",scripts:["dashboard.service.js","dashboard.js"]})},{path:"/zygl/frame-page/",name:"frame",component:Qz.component({module:"frame-page",template:"frame.html",scripts:["frame.js"]})}],n=(Object.keys(Qz.routes).forEach(function(n){Qz.routes[n].forEach(function(e){var t="/"+n+"/"+e.name+"/";e.path,e.path=e.path||t,e.component=Qz.component({app:n,module:e.name,template:e.name+".html",scripts:e.scripts}),i.push({path:e.path,name:e.name,component:e.component,meta:{resCode:e.resCode,workflow:e.workflow,cache:e.workflow?!e.workflow:e.cache}})})}),i.unshift(n),new VueRouter({routes:i}));window.addEventListener("unhandledrejection",function(e){e.preventDefault()}),window.app=new Vue({el:"#app",router:n,store:e,components:{dialogMessage:Qz.component({module:"custom-page",template:"dialog-message.html",scripts:["dialog.message.js"]})},data:function(){return{resCode:"ZYGL9901",isFullscreen:!1,closeTabIndex:1,language:Qz.settings.language,favoriteMenuList:[],historyMenuList:[],menuList:[],roleList:[],roleCode:"",tabs:[{label:"zh_CN"===Qz.settings.language?"个人中心":"User Center",name:"/",closable:!1}],containerHeight:"",windowWidth:"",showMenuChild:!1,mouseObj:{clientX:""},mapRouter:{},menuMap:{},firstMenuHeight:"",showMainMenu:!1,isShowFirstIcon:!1,isShowDialogMessage:!1,arrowMenuShow:!1,firstMenuColor:["#178fe6","#1cc898","#555dba8","#eec224","#f2766d","fbb289","#7a9fff"],newMessageData:[],messageNoticeObj:"",accountType:"",fullHeight:window.innerHeight,sideMenuHeight:window.innerHeight-269-58,menuName:"",allMenus:[]}},computed:{workflowTag:function(){return this.$route.meta.workflow},userInfo:function(){var e=Qz.getCv("simulatedBy")()?"("+(this.resI18n.lb_simulatedUser||"模拟用户")+")":"";return this.loginUser.name+e},tabRouteNames:function(){var e=(this.usersettingsSession?this.tabs.filter(function(e){return!1!==e.cache}):this.tabs.filter(function(e){return!0===e.cache})).map(function(e){var t=e.componentName;return t||(e=(-1<e.name.indexOf("target=_inner")?"/zygl/frame/":e.name).split("/"))[2]&&(t=e[2].replace(/\?.+/,"")),t});return this.usersettingsSession&&e.push("dashboard"),e.join(",")},excRouteNames:function(){var n=[];return(this.usersettingsSession?this.tabs.filter(function(e){return!1===e.cache}):this.tabs.filter(function(e){return!1!==e.cache})).forEach(function(e){var t=e.componentName;t||(e=(-1<e.name.indexOf("target=_inner")?"/zygl/frame/":e.name).split("/"))[2]&&(t=e[2].replace(/\?.+/,"")),t&&n.push(t)}),this.workflowTag&&n.push(this.$route.name),n.join(",")},isShowSubMenu:function(){return this.showMenuChild},isopen:function(){var t=this;return 0==this.tabs.findIndex(function(e){return e.name===t.$route.path})},isopen1:function(){var t=this;return this.tabs.findIndex(function(e){return e.name===t.$route.path})==this.tabs.length-1},path:function(){var e=this.$route.path,t=this.$route.query;return t.src&&-1<t.src.indexOf("target=_inner")?t.src:this.mapRouter[e]||e},messageList:function(){return this.$store.state.m.messageList},messageData:function(){return this.messageList.filter(function(e){return"1"===e.promptModel})},noticeData:function(){return this.messageList.filter(function(e){return"2"===e.promptModel})},newMsg:function(){return!!this.messageData.length}},created:function(){var n=this;http.postJSON("GRZX01_jwPublic.controller.UserIndexController.findUserDetail",{sctype:"rmdx",userType:Qz.loginUser.userType||""},{},{loading:!1}).then(function(e){e&&e.holder?(e.holder.userInfo&&"teacher"==e.holder.userInfo.usertypes?(n.accountType="1",n.menuList="PCWEBBZJSMH"==t[0].menuCode?[].concat(_toConsumableArray(t[0].children.slice(1)),_toConsumableArray(t.slice(1))):t):e.holder.userInfo&&"student"==e.holder.userInfo.usertypes?(n.accountType="2",n.menuList="PCWEBBZXSMH"==t[0].menuCode?[].concat(_toConsumableArray(t[0].children.slice(1)),_toConsumableArray(t.slice(1))):t):(n.accountType="0",n.menuList=t),frameService.favoriteMenuList().then(function(e){e.forEach(function(e){n.menuMap[e]&&(n.menuMap[e].favorite=!0,n.favoriteMenuList.push(n.menuMap[e]))})}).catch(function(e){}),n.getHistoryMenu(),n.menuList&&0<n.menuList.length&&n.menuList.forEach(function(e){var t=e.children;e.url&&n.allMenus.push({menuName:e.name,menuUrl:e.url}),t&&0<t.length&&t.forEach(function(e){var t=e.children;e.url&&n.allMenus.push({menuName:e.name,menuUrl:e.url}),t&&0<t.length&&t.forEach(function(e){var t=e.children;e.url&&n.allMenus.push({menuName:e.name,menuUrl:e.url}),t&&0<t.length&&t.forEach(function(e){var t=e.children;e.url&&n.allMenus.push({menuName:e.name,menuUrl:e.url}),t&&0<t.length&&(t.forEach(function(e){e.children;e.url&&n.allMenus.push({menuName:e.name,menuUrl:e.url})}),children5)&&0<children5.length&&children5.forEach(function(e){e.url&&n.allMenus.push({menuName:e.name,menuUrl:e.url})})})})})})):(n.accountType="2",n.menuList="PCWEBBZXSMH"==t[0].menuCode?[].concat(_toConsumableArray(t[0].children.slice(1)),_toConsumableArray(t.slice(1))):t,"/"==n.$route.path&&n.$router.push("/student"))}),this.initRoleList(),this.setMapRouter(t)},watch:{isFullscreen:function(e){e&&$message(this.resI18n.lb_screen_tips||"双击选项卡取消全屏"),this.$store.commit("windowSizeChangeToggle"),this.changeTableHeight(),this.setFirstMenuHeight()},$route:function(e){e.path;var t=e.meta,e=e.name,n=this.path,i=(this.path.split("/").length<=2&&(this.tabs[0].name=this.path),this.tabs.find(function(e){return e.name===n})),s=filterMenu(this.menuList,n);this.setRmdxCofig(!1),!i&&s&&this.tabs.push({label:s.label,name:s.index,closable:!0,cache:t.cache,componentName:e,code:s.code})},messageList:function(e,t){this.$nextTick(function(){this.saveLocalMessageData()})},"$store.state.requestDone":function(){this.setRmdxCofig(!1)},fullHeight:function(e,t){this.sideMenuHeight=e-269-58}},methods:{querySearchAsync:function(t,e){if(t){if(t.length<2)return e([]);var n=this.allMenus.filter(function(e){return 0<=e.menuName.indexOf(t)}),i=[];e(i=n&&0<n.length?n.map(function(e){return{value:e.menuName,url:e.menuUrl}}):i)}else this.menuName="",e([])},selectMenu:function(e){e.url&&this.goMenu(e.url)},messageSuggestion:function(){var t=this;this.$dialog({module:"message-suggestion",template:"message-suggestion.html",scripts:["message.suggestion.js"]}).then(function(e){e&&t.$message({type:"success",message:t.resI18n.lb_add_success||"提交成功"})})},changeSideMenuHeight:function(){var e=this;setTimeout(function(){e.$refs["side-menu"]&&e.$refs["side-menu"].update()},500)},hidePop:function(){var t=this;["popover-switch-role","popover-func"].forEach(function(e){return t.$refs[e].showPopper=!1})},showMessageDialog:function(){this.messageList.length&&(this.hidePop(),this.$dialog({module:"custom-page",template:"message-center-dialog.html",scripts:["message.center.dialog.js"]}).then(function(e){}))},openMessageNotice:function(t){var n=this;if(!this.messageNoticeObj){for(var e=0,i=this.$createElement,s=void 0,o=void 0,a=document.body.getBoundingClientRect().bottom,r=document.createElement("div"),u=(r.innerHTML=t.content,s=r.innerText,r=null,s),l=188,c=0,h=void 0,m=!1,h=0;h<u.length;h++){if(l<c){m=!0;break}c+=u.charCodeAt(h)<127?1:2}s=m?u.slice(0,h-1)+"...":u.slice(0,h-1),o=Math.ceil(Math.ceil(c/2)/24),e=a-(97+21*o+16+16),r=i("div",{class:{"notice-content":!0}},[s,i("div",{},[i("ElButton",{props:{type:"text"},class:{right:!0},on:{click:function(e){e.preventDefault(),n.messageNoticeClick(t)}}},this.resI18n.lb_see||"查看")])]),this.messageNoticeObj=this.$notify({title:t.title,message:r,duration:window.Qz.config.opts.showTime,offset:e,onClose:this.messageNoticeClose,customClass:"notice-ellipsis"})}},messageNoticeClick:function(e){var t;this.messageNoticeObj&&(t={messageDetailId:e.messageDetailId},e.functionUrl?this.$router.push({path:e.functionUrl,query:t}):this.$router.push({path:"/xxzx/receive-msg",query:t}),this.messageNoticeObj.close(),this.messageNoticeObj=null)},messageNoticeClose:function(e){this.messageNoticeObj=null},openMessageDialog:function(e){var t=this;this.newMessageData.push(e),this.isShowDialogMessage||this.$dialog({module:"custom-page",template:"dialog-message.html",scripts:["dialog.message.js"]},this.newMessageData).then(function(e){t.closeMessageDialog(e)}),this.isShowDialogMessage=!0},closeMessageDialog:function(t){this.isShowDialogMessage=!1,this.newMessageData=this.newMessageData.filter(function(e){return!t.includes(e.messageDetailId)}),this.$store.commit("m/delete",t)},handleMessageInfo:function(e){"1"===e.promptModel?(this.$store.commit("m/add",e),this.openMessageNotice(e)):"2"===e.promptModel&&(this.$store.commit("m/add",e),this.openMessageDialog(e))},saveLocalMessageData:function(){try{localStorage.setItem(this.loginUser.username+":messageList",JSON.stringify(this.messageList))}catch(e){localStorage.clear()}},getLocalMessageData:function(){var t=this,e=localStorage.getItem(this.loginUser.username+":messageList");e&&(e=JSON.parse(e)).forEach(function(e){return t.$store.commit("m/add",e)})},setFirstMenuHeight:function(){this.$nextTick(function(){var e=this.$refs.sidebar&&this.$refs.sidebar.getBoundingClientRect().height-43,t=35*this.menuList.length,e=Math.max(e,t);this.firstMenuHeight=e})},getHistoryMenu:function(){var t=this;frameService.getHistoryMenu({count:"8"}).then(function(e){(e=e||[]).forEach(function(e){t.menuMap[e]&&t.historyMenuList.push(t.menuMap[e])})}).catch(function(e){})},postHistoryMenu:function(e){frameService.postHistoryMenu(e).then(function(e){}).catch(function(e){})},setMapRouter:function(e){var n=this;e.forEach(function(e){var t;-1<e.index.indexOf("?")&&(t=e.index.split("?"),n.$set(n.mapRouter,t[0],e.index)),n.$set(n.menuMap,e.code,e),e.children&&n.setMapRouter(e.children)})},findMenuChild:function(e,t){var n,i=this;return Array.isArray(e)?(n=void 0,e.forEach(function(e){i.findMenuChild(e,t)&&(n=!0)}),!!n||void 0):e.index===t||(e.children.length?this.findMenuChild(e.children,t):void 0)},showMenuChildEvent:function(){this.showMenuChild=!this.showMenuChild},resize:function(e){this.$store.commit("windowSizeChangeToggle");var e=(e.target||e.srcElement).innerWidth,t=this.windowWidth,t=0<e-t?1:e===t?0:-1;this.windowWidth=e,this.$store.commit("windowWidthChange",t),this.changeTableHeight(),this.setFirstMenuHeight()},onTabClick:function(e){this.goMenu(e.name)},onTabRemove:function(t){var e=this.tabs.findIndex(function(e){return e.name===t}),e=(this.closeTabIndex=e,this.tabs.splice(e,1),this.tabs[e-1]);t===this.path&&this.goMenu(e.name)},initRoleList:function(){var e=this,t=window.Qz.roleListInfo,n=t.roleCode,t=t.roleList;this.roleList=t,this.$nextTick(function(){e.roleCode=n})},localStorageForSettings:function(t){var e=Qz.loginUser.username+":config",n=localStorage.getItem(e);n&&(n=JSON.parse(n),Object.keys(t).forEach(function(e){n[e]=t[e]}),localStorage.setItem(e,JSON.stringify(n)))},switchRole:function(e,t){var n=this,t=_slicedToArray(t,2),i=t[0],i=void 0===i?"":i,t=t[1],t=void 0===t?"":t,s=((t=t.slice(i.length))||(t=i,i=""),JSON.stringify({agent:i,roleCode:t}));frameService.switchRole(t,i).then(function(e){n.localStorageForSettings({userRole:s});var t=window.location.origin+window.location.pathname;window.location.href=t})},goMenu:function(t){if(-1<t.indexOf("target=_new"))window.open(t);else{if(this.tabs.length>=Qz.tabsCount){var e,n=this.tabs.find(function(e){return e.name===t});if("default"===Qz.settings.tabs){if(!n)return e=(this.resI18n.lb_tabs_count||"标签数量限制为[{%s}]个!").replace(/{%s}/,Qz.tabsCount),void this.$message(e)}else n||this.tabs.splice(1,1)}-1<t.indexOf("target=_inner")?(this.$set(this.mapRouter,t,"/zygl/frame-page"),this.$router.push({path:"/zygl/frame-page",query:{src:t}})):(this.$router.push({path:t}),this.setRmdxCofig(!0))}},setRmdxCofig:function(e){!e&&Qz.$num||(Qz.isRmdx=e)},logout:function(){var e=Qz.getCv("simulatedBy")();(e=e&&window.encodeURIComponent(e))?http.postJSON(""+location.origin+Qz.secApiPath+"/simulateLogout?Simulated-By="+e+"&resourceCode=resourceCode&apiCode=framework.sign.controller.SignController.logout").then(function(e){Qz.setCookie("token",e.TOKEN),location.href=e.service}):http.postJSON(""+location.origin+Qz.secApiPath+"/logout?resourceCode=resourceCode&apiCode=framework.sign.controller.SignController.logout").then(function(e){Qz.removeCookie("token"),document.write('<html><head><title>中国人民大学</title><link rel="shortcut icon" href="/Njw2017/logo.png"/></head><body style="padding:100px"><h2 style="text-align:center">您已成功退出教务系统</h2><h2 style="text-align:center"><input align="right" type="button" style="background-color:#AE0C2A;border:none;width:100px;color:white;height:35px;border-radius:5px;" value="重新进入" onclick="location.href=\''+e+"'\"/></h2></body></html>")})},showSettingsDialog:function(){this.hidePop(),this.$dialog({module:"user-settings",template:"custom-settings-dialog.html",scripts:["custom.settings.service.js","custom.settings.dialog.js"]}).then(function(e){location.reload()})},goRight:function(){var t=this.path,e=this.tabs.findIndex(function(e){return e.name===t})+1;this.tabs.length>e&&(e=this.tabs[e].name)&&this.goMenu(e)},goLeft:function(){var t=this.path,e=this.tabs.findIndex(function(e){return e.name===t});0!==e&&(e=this.tabs[e-1].name)&&this.goMenu(e)},onTabClose:function(e){var t=this.mapRouter[this.$route.path]||this.$route.path,n=this.tabs.findIndex(function(e){return e.name===t});"me"===e?n&&(this.tabs.splice(n,1),this.onTabClick(this.tabs[n-1])):"all"===e?(this.tabs.splice(1),this.onTabClick(this.tabs[0])):"right"===e?this.tabs.splice(n+1):"others"===e&&(this.tabs=this.tabs.filter(function(e,t){return 0===t||t===n}))},onFavorite:function(t){var n=this;t.favorite?frameService.delFavoriteMenu(t.code).then(function(){t.favorite=!1;var e=n.favoriteMenuList.findIndex(function(e){return e.url===t.url});n.favoriteMenuList.splice(e,1),$message(n.resI18n.lb_collection_cancel||"取消收藏成功")}).catch(function(e){n.$message(n.resI18n.lb_collection_cancel_failure||"取消收藏失败")}):frameService.addFavoriteMenu(t.code).then(function(){t.favorite=!0,n.favoriteMenuList.push(t),$message(n.resI18n.lb_collection_success||"添加收藏成功")}).catch(function(e){n.$message(n.resI18n.lb_collection_failure||"添加收藏失败")})}},mounted:function(){var t=this;window.addEventListener("resize",function(e){throttle(t.resize,null,20,e,100),t.fullHeight=window.innerHeight},!1),this.windowWidth=window.innerWidth,this.setFirstMenuHeight(),this.changeSideMenuHeight();try{if(void 0===this.$socket.readyState)return void this.$notify({title:this.resI18n.lb_title1||"浏览器不支持消息提醒",message:this.resI18n.lb_message_msg||"当前浏览器不支持消息提醒，请使用新版谷歌浏览器！",duration:0,customClass:"notice-ellipsis"});var e,n,i,s=window.Qz.settings.websocket;s?(e=location.host,n=0===s.indexOf("ws")?s:"ws://"+e+s,window.Qz.config.ws=n,i={authcode:this.loginUser.username,identity:this.loginUser.username,TOKEN:Qz.getCookie("token",!1),accessToken:Qz.getCv("sid")()},this.$socket.open(!1,i)):this.$notify.error({title:this.resI18n.lb_msg_frame||"当前系统未配置消息管理中心",message:"",duration:0,offset:60,customClass:"notice-ellipsis"})}catch(e){}document.title=Qz.settings.reportunit||"",setTimeout(function(){t.getLocalMessageData()}),this.$socket.addEventListener("error",function(e){})},socket:{events:{message:function(e){"string"!=typeof e&&this.handleMessageInfo(e)},foreCache:function(e){e=e.content;this.$appStore.dispatch(e.type,Object.assign(e.value,{isMsg:!0}))}}}}),n.afterEach(function(e){var e=filterMenu(app.menuList,e.path),t=Qz.settings.reportunit||"",e=(e&&(t=e.name+" -  "+t,2!==e.index.split("/").length)&&app.postHistoryMenu(e.code),document.title=t,document.createElement("link")),t=document.getElementsByTagName("head")[0];e.type="image/png",e.rel="shortcut icon",e.href="/Njw2017/logo.png",t.appendChild(e)})}),function e(t,n){var i=!0,s=!1,o=void 0;try{for(var a,r=t[Symbol.iterator]();!(i=(a=r.next()).done);i=!0){var u=a.value;if(u.index===n)return u;var l=e(u.children,n);if(l)return l}}catch(e){s=!0,o=e}finally{try{!i&&r.return&&r.return()}finally{if(s)throw o}}});